- hosts: all
  sudo: yes
  roles:
     - { role: djcf.fish, fish_users: ['vagrant'] }
     - abaez.docker
  tasks:
    - name: Install nano
      apt:
        name: nano
        state: present

    - name: remove pre-built app containers (wp)
      docker:
        name: docker_wordpress_1
        image: wordpress
        state: absent

    - name: remove pre-built app containers (fpm)
      docker:
        name: docker_fpm_1
        image: fpm
        state: absent

    - name: host should have ansible
      apt:
        name: ansible
        state: present

    - name: configure systemd to activate docker containers
      copy: src={{ item }} dest=/etc/systemd/system/ owner=root group=root mode=655
      with_fileglob:
        - ../../systemd.services/*
      notify: reload systemd

    - name: reload systemd
      become: yes
      command: systemctl daemon-reload

    - name: install a 'ghost' wordpress directory for nginx to test file existence against during requests
      become: yes
      unarchive:
        src: https://wordpress.org/latest.zip
        dest: /var/lib
        remote_src: true
        creates: /var/lib/wordpress

    - name: set fact -- number of CPUs
      command: grep processor /proc/cpuinfo | wc -l
      register: worker_processes
      changed_when: false

    - name: template out a new nginx.conf file with the appropriate number of workers for this host
      template: src=resources/nginx.conf.j2 dest="/vagrant/docker/switchboard/nginx.conf"


#    - name: host should have latest version of docker-compose
#      shell: curl -L https://github.com/docker/compose/releases/download/1.9.0/docker-compose-$(uname -s)-($uname -m) > /usr/local/bin/docker-compose

#    - name: Install pip
#      apt:
#        pkg: "{{ item }}"
#        state: installed
#      with_items:
#        - python-dev
#        - python-pip

#    - name: Install Docker-py
#      pip:
#        name: docker-py
#        version: 1.1.0

#    - name:
#    - name: Host should have docker.py
#      become: true
#      pip: state=present name="{{ item }}"
#      with_items:
#        - docker-py==1.2.3
#        - six==1.10.0