---
# Usage: ansible-playbook --extra-vars "domain=mydomain.org subdomain=mysubdomain.noflag.org.uk" add-wordpress-vhost.yml
- hosts: all
  vars:
    - docker_image: "fpm"
  vars_files:
    - resources/vars_docker_conf.yml
    - resources/vars_db.yml
    - resources/vars_php.yml
  #connection: docker
  sudo: yes
  tasks:
    - include: inc/tasks-add-vhost.yml
    - include: inc/tasks-add-container.yml
    - include: inc/tasks-create-database.yml

    # Shell equivilent:
    # docker create --name $domain.fpm wordpress --net=docker_sqlnet --volumes {} wordpress
    - name: Create php container for new site
      docker_container:
        name: "{{ domain }}.fpm"
        image: "{{ docker_image }}"
        state: "{{ state }}"
        networks:
          - name: docker_sqlnet
            link: "{{ db_host }}"
        volumes:
          - "/var/run/docker-apps/{{ domain }}:/var/run/docker-apps"
          - "/var/www/{{ domain }}/public_html/wp-content:/var/lib/wordpress/wp-content"
          - "/etc/ssmtp:/etc/ssmtp:ro"
        env_file: "/var/www/{{ domain }}/.env"
      become: yes


    # Shell equiv:
    # systemctl enable fpm-waker@$domain.socket; systemctl start fpm-waker@$domain.socket
    # This command tells systemd to create a listening socket in /var/run/docker-apps/$domain. This socket listens for incoming traffic
    # When received, systemd starts the docker container and then proxies the incoming traffic into it.
    - name: Create a systemd wake socket for the new container
      systemd:
        name: "fpm-waker@{{ domain }}.socket"
        state: started
        enabled: true
      become: yes